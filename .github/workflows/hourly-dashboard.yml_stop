name: KxShare Hourly Dashboard

on:
  schedule:
    - cron: "0 * * * *" # Har ghante
  workflow_dispatch:

jobs:
  hourly-dashboard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate Hourly Uptime Dashboard
        run: |
          echo "Generating hourly dashboard..."
          avg_time=$(curl -s -w "%{time_total}" -o /dev/null --max-time 10 https://kxshare.onrender.com || echo "Curl failed")
          response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://kxshare.onrender.com || echo "Curl failed")
          echo "HTTP Response: $response, Avg Time: $avg_time"

          # Calculate success and failure counts from ping_results.csv
          if [ -f ping_results.csv ]; then
            # Get current time and time 1 hour ago in UTC
            current_time=$(date -u +"%s")
            one_hour_ago=$((current_time - 3600))
            
            success_count=0
            failure_count=0
            
            # Read ping_results.csv and count success/failures in last hour
            while IFS=, read -r timestamp http_code; do
              ts=$(date -d "$timestamp" +"%s" 2>/dev/null || continue)
              if [ "$ts" -ge "$one_hour_ago" ] && [ "$ts" -le "$current_time" ]; then
                if [ "$http_code" = "200" ]; then
                  success_count=$((success_count + 1))
                else
                  failure_count=$((failure_count + 1))
                fi
              fi
            done < ping_results.csv
            
            total_checks=$((success_count + failure_count))
            if [ $total_checks -eq 0 ]; then
              total_checks=1
              success_count=0
              failure_count=0
              echo "No valid checks found in last hour, using fallback counts."
            fi
          else
            success_count=0
            failure_count=0
            total_checks=1
            echo "No ping_results.csv found, using fallback counts."
          fi

          # Send hourly update to Telegram
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="KxShare Uptime Dashboard - Last 1h\nSuccess: $success_count/$total_checks\nFailures: $failure_count\nAvg Response: $avg_time s\nNext scan in 1 hour" || echo "Failed to send Telegram dashboard"
